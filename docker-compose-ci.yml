version: "2.4"

services:
  web:
    image: paneldata/ddionrails:latest-dev
    command:
      [
        "gunicorn",
        "config.wsgi",
        "--bind",
        "0.0.0.0:8000",
        "--error-logfile",
        "-",
        "--access-logfile",
        "-",
        "--log-level=info",
        "--access-logformat",
        '[gunicorn] %(h)s %(l)s %(t)s "%(r)s" %(s)s %(b)s "%(f)s" "%(a)s"',
      ]
    depends_on:
      postgres:
        condition: service_healthy
      elasticsearch:
        condition: service_healthy
      selenium-firefox:
        condition: service_started
    env_file:
      - docker/environments/django.env.example
      - docker/environments/database.env.example
      - docker/environments/elasticsearch.env.example
    entrypoint: ./docker/ddionrails/entrypoint.sh
    environment:
      DJANGO_SETTINGS_MODULE: config.settings.development
      ELASTICSEARCH_DSL_INDEX_PREFIX: testing_
    pids_limit: -1
    volumes:
      - ./codecov:/usr/src/app/codecov
      - ./dist:/usr/src/app/static/dist
      - ./assets:/usr/src/app/assets
      - ./config:/usr/src/app/config
      - ./ddionrails:/usr/src/app/ddionrails
      - ./docker:/usr/src/app/docker
      - ./local:/usr/src/app/local
      - ./static:/usr/src/app/static
      - ./templates:/usr/src/app/templates
      - ./tests:/usr/src/app/tests
      - ./manage.py:/usr/src/app/manage.py
      - ./logging.conf:/usr/src/app/logging.conf
      - ./package-lock.json:/usr/src/app/package-lock.json
      - ./package.json:/usr/src/app/package.json
      - ./pavement.py:/usr/src/app/pavement.py
      - ./setup.cfg:/usr/src/app/setup.cfg
      - ./Pipfile:/usr/src/app/Pipfile
      - ./Pipfile.lock:/usr/src/app/Pipfile.lock
      - ./webpack.config.js:/usr/src/app/webpack.config.js

  postgres:
    env_file:
      - docker/environments/database.env.example

  nginx:
    volumes:
      - ./docker/nginx/nginx.dev.conf:/etc/nginx/nginx.conf

  selenium-firefox:
    image: selenium/standalone-firefox:4.0.0-rc-2-prerelease-20210923
    shm_size: "2gb"
    ports:
      - 4444
    networks:
      - ddi_net
